# lucet

## Contents

### lucetc

`lucetc` is the Lucet Compiler.

The rust crate `lucetc` provides an executable called `lucetc`. This
executable translates WebAssembly modules (`.wasm` files) into native code
(`.o` files).

The `scripts` subdirectory provides two additional executables called `lucetcc`
and `lucetld`.  They are designed to be stand-ins (via the `CC` env variable or
otherwise) for a standard C compiler (like `cc`) and a standard linker (like
`ld`). They shell out to the `clang` compiler (using the WebAssembly backend)
to compile C code into WebAssembly object files (not an actual standard, just
an intermediate format used by clang), LLVM's `wasm-ld` to link WebAssembly
object files into WebAssembly modules, and `lucetc` to compile WebAssembly
modules into native code.

### lucet-runtime-c (`liblucet-runtime-c`)

`liblucet-runtime-c` is the runtime for WebAssembly modules compiled through `lucetc`. It is
a C library that provides the functionality to load, instantiate, and call
exported WebAssembly functions. The bulk of the complexity is in managing the
implementation of linear memory, and the exception mechanisms that detect and
recover from illegal operations.

### lucet-backtrace

Backtrace functionality for `liblucet-runtime-c`: makes its best effort to
determine the call stack that led to `liblucet-runtime-c` terminating the guest
with a fault.

Depends on libunwind 1.2.

### lucet-analyze

Rust executable for inspecting the contents of a shared object generated by `lucetc`.

### lucetidl

Rust library/executable for describing datastructures and, eventaully, interfaces.
In its infancy at the time of writing.

### lucet-libc

Packages a subset of the musl libc library, and LLVM's compiler-rt library
(which provides compiler builtins), as a static library of WebAssembly object
files. Also provides the runtime component used to support the libc's host calls
in `liblucet-runtime-c`.

Instead of using the allocator (`malloc` implemention) shipped as part of
`musl`, we use the much simpler `lend` library, and use the `expand_memory`
WebAssembly opcode to create the arena used by `lend`.

We use a custom python-generated Ninja build script to build and package
this library.

Libc functionality is very limited - it's mostly there for the header files,
`malloc`, and some basic string manipulation functions. There is a stdio
facility, but it has some longstanding bugs.

### lucet-rs

Rust crate that wraps liblucet-runtime-c (in crate `lucet-sys`) and provides an
idiomatic Rust API for it (in crate `lucet`).

### lucet-spectest

Rust crate that uses `lucetc` and `lucet-rs`, as well as the (external) `wabt`
crate, to run the official WebAssembly spec suite, which is provided as a
submodule in this directory.

### Vendor libraries

Lucet is tightly coupled to several upstream dependencies, and Lucet
development often requires making changes to these dependencies which are
submitted upstream once fully baked. To reduce friction in this development
cycle, we use git submodules to vendor these modules into the Lucet source
tree. The submodules point at forks under the github.com/fastly orginization to
meet Fastly's source control requirements.

#### Cranelift

We keep the primary Cranelift project repository as a submodule at
`/cranelift`.  The git repo at `https://github.com/fastly/cranelift`
mirrors upstream `https://github.com/cranestation/cranelift`.

Cranelift provides the native code generator used by `lucetc`, and a ton of
supporting infrastructure.

Cranelift was previously known as Cretonne.  Project developers hang out in the
`#cranelift` channel on `irc.mozilla.org:6697`.

#### Faerie

Faerie is a Rust crate for producing ELF files.  Faerie is used by Cranelift
(through the module system's `cranelift-faerie` backend) and also directly by
`lucetc`, for places where the `cranelift-module` API can't do everything we
need.

### Tests

### Integration test suite

Tests that use both `lucetc` and `liblucet-runtime-c` live in `/tests`. We call
these the "integration tests".

### Benchmarks

We created the `sightglass` benchmarking tool to measure the runtime of C code
compiled through a standard native toolchain against the Lucet toolchain. It
is provided as a submodule at `/sightglass`.

Sightglass ships with a set of microbenchmarks called `shootout`. The scripts
to build the shootout tests with native and various versions of the Lucet
toolchain are in `/benchmarks/shootout`.

## Development Environment

### Operating System

Lucet is developed and tested on Linux. We expect it to work on any POSIX
system which supports ELF.

Experimentally, we have shown that supporting Mac OS (which uses the mach-o
executable format instead of ELF) is possible, but it is not supported at this
time.

### Dependencies

Lucet requires:

* Clang/LLVM 7.0 with the experimental WebAssembly backend enabled, wasm-ld via
  lld, and clang-format
* Rust stable, and rustfmt. We typically track the latest stable release.
* GNU Make, CMake, Ninja, python 2, & various standard unix utilities for the
  build system
* libunwind, for backtraces
* libhwloc, for sightglass to pin benchmarks to a single core
* libbsd, for some C headers

### Docker container

A Docker container which includes all dependencies is provided in `Dockerfile`.
A set of `devenv` shell scripts automate building and running this container,
for those who may be unfamilar with Docker.

First, use `devenv_build_container` to create a docker image from `Dockerfile`.
You will need to rerun this only if the Dockerfile changes.

Then, use `devenv_run` to open an interactive shell in the container, or pass
arguments to `devenv_run` to run them as a command in the container.
`devenv_run` will automatically start the container if it is not running. You
can manually start and stop the container with `devenv_start` and `devenv_stop`.


